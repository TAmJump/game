<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EMS Tactics â€“ JP_001 (Octopath-like UI)</title>
  <style>
    :root{
      --gold:#d7c08a;
      --gold2:#b79b55;
      --ink:#0b0b0d;
      --panel: rgba(10,10,12,.62);
      --panel2: rgba(18,18,22,.72);
      --line: rgba(215,192,138,.75);
      --soft: rgba(255,255,255,.10);
      --accent:#ffb84d;
      --blue:#4aa3ff;
      --green:#3fd19a;
      --danger:#ff4b4b;
    }
    html,body{height:100%; margin:0; background:#000; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;}
    #game{ position:relative; width:100%; height:100%; overflow:hidden; background:#000; }
    canvas{position:absolute; inset:0; width:100%; height:100%;}

    #vfx{
      pointer-events:none;
      position:absolute; inset:-10%;
      background:
        radial-gradient(60% 60% at 50% 55%, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 85%),
        linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45));
      mix-blend-mode:multiply;
      filter: blur(.2px);
    }
    #grain{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
      animation: grain 1.8s steps(2) infinite;
    }
    @keyframes grain { 0%{transform:translate(0,0)} 50%{transform:translate(-2%,1%)} 100%{transform:translate(0,0)} }

    .hud{position:absolute; inset:0; pointer-events:none;}
    .panel{
      pointer-events:none;
      position:absolute;
      color:#f3ead6;
      background: linear-gradient(180deg, rgba(25,22,18,.78), rgba(10,10,12,.62));
      border:1px solid var(--line);
      box-shadow: 0 0 0 2px rgba(0,0,0,.35) inset, 0 18px 45px rgba(0,0,0,.55);
      border-radius:10px;
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(120% 120% at 20% 0%, rgba(255,220,140,.10), transparent 40%),
        radial-gradient(120% 120% at 90% 20%, rgba(255,255,255,.06), transparent 40%);
      pointer-events:none;
    }
    .panel .head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      letter-spacing:.08em;
      font-weight:700;
      color:#f7edd6;
      text-shadow:0 2px 0 rgba(0,0,0,.45);
      border-bottom:1px solid rgba(215,192,138,.35);
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,0));
    }
    .panel .body{padding:10px 12px; font-size:14px; line-height:1.4;}
    .panel small{opacity:.8}
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:4px 8px; border:1px solid rgba(215,192,138,.45);
      border-radius:999px; background:rgba(0,0,0,.25);
      font-weight:700; font-size:12px;
    }
    .iconDot{width:8px; height:8px; border-radius:99px; background:var(--accent); box-shadow:0 0 10px rgba(255,184,77,.55);}

    #scorePanel{left:14px; top:14px; width:320px;}
    #scorePanel .body{display:flex; gap:10px; flex-direction:column;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .row .k{opacity:.85}
    .row .v{font-weight:800}
    .submenu{display:flex; gap:8px; flex-wrap:wrap;}
    .pill{
      padding:6px 10px;
      border:1px solid rgba(215,192,138,.35);
      border-radius:999px;
      background: rgba(0,0,0,.25);
      font-weight:700;
      font-size:12px;
      opacity:.95;
    }

    #missionPanel{right:14px; top:14px; width:360px;}
    .missionLine{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 0; border-bottom:1px dashed rgba(215,192,138,.18);
    }
    .missionLine:last-child{border-bottom:none;}
    .chk{
      display:inline-flex; width:18px; height:18px; border-radius:4px;
      border:1px solid rgba(215,192,138,.55); align-items:center; justify-content:center;
      margin-right:8px; background:rgba(0,0,0,.25);
      font-weight:900; color:#101014;
    }
    .done .chk{background:rgba(63,209,154,.85); border-color:rgba(63,209,154,.95);}
    .done .txt{opacity:.65; text-decoration:line-through;}
    .tag{
      font-weight:900;
      border:1px solid rgba(215,192,138,.35);
      border-radius:8px;
      padding:2px 8px;
      background:rgba(0,0,0,.22);
      font-size:12px;
      opacity:.95;
    }

    #actionBar{
      left:14px; bottom:14px;
      display:flex; gap:10px;
      pointer-events:none;
    }
    .actionBtn{
      pointer-events:auto;
      min-width:118px;
      padding:12px 12px;
      border-radius:10px;
      border:1px solid rgba(215,192,138,.55);
      background: linear-gradient(180deg, rgba(20,18,14,.82), rgba(0,0,0,.55));
      color:#f7edd6;
      font-weight:900;
      letter-spacing:.08em;
      box-shadow:0 14px 28px rgba(0,0,0,.55);
      cursor:pointer;
      user-select:none;
    }
    .actionBtn:active{transform:translateY(1px)}
    .actionBtn .mini{display:block; opacity:.8; font-size:12px; margin-top:3px; font-weight:700}
    .actionBtn.primary{outline:2px solid rgba(255,184,77,.25);}

    #treatPanel{
      right:14px; bottom:14px; width:min(520px, calc(100% - 28px));
      pointer-events:none;
    }
    #treatPanel .body{display:flex; gap:10px;}
    #treatLeft{flex:1; min-width:0;}
    #treatRight{width:170px; display:flex; flex-direction:column; gap:10px;}
    .note{
      font-size:12px; opacity:.85; line-height:1.4;
      border:1px dashed rgba(215,192,138,.25);
      padding:8px; border-radius:8px; background:rgba(0,0,0,.18);
    }
    .tbtn{
      pointer-events:auto;
      display:flex; align-items:center; justify-content:center;
      padding:12px 10px;
      border-radius:10px;
      border:1px solid rgba(215,192,138,.55);
      background: linear-gradient(180deg, rgba(13,13,16,.65), rgba(0,0,0,.45));
      color:#f7edd6;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      letter-spacing:.10em;
    }
    .tbtn.good{border-color:rgba(63,209,154,.85);}
    .tbtn.bad{border-color:rgba(255,75,75,.85);}
    .tbtn:active{transform:translateY(1px)}
    .meter{
      height:8px; border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.08); border:1px solid rgba(215,192,138,.18);
    }
    .meter > i{display:block; height:100%; width:50%; background:rgba(74,163,255,.85)}
    .hint{
      position:absolute; left:50%; top:12px; transform:translateX(-50%);
      pointer-events:none;
      padding:8px 12px;
      border:1px solid rgba(215,192,138,.35);
      border-radius:999px;
      background:rgba(0,0,0,.35);
      color:#f7edd6;
      font-weight:800;
      letter-spacing:.06em;
      opacity:.95;
      white-space:nowrap;
    }

    #party{
      position:absolute; left:14px; top:132px;
      display:flex; gap:8px; pointer-events:auto;
    }
    .slot{
      width:44px; height:44px;
      border-radius:10px;
      border:1px solid rgba(215,192,138,.45);
      background:rgba(0,0,0,.35);
      display:grid; place-items:center;
      color:#f7edd6; font-weight:1000;
      cursor:pointer; user-select:none;
      box-shadow:0 10px 22px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }
    .slot.active{outline:2px solid rgba(255,184,77,.35);}
    .slot span{font-size:12px; opacity:.9}
    .slot::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(120% 120% at 30% 10%, rgba(255,255,255,.12), transparent 40%);
      pointer-events:none;
    }

    @media (max-width: 780px){
      #scorePanel{width: calc(100% - 28px);}
      #missionPanel{width: calc(100% - 28px); top:auto; bottom: 250px;}
      #party{top: 210px;}
      #treatPanel{width: calc(100% - 28px);}
      #actionBar{flex-wrap:wrap}
      .actionBtn{min-width:calc(50vw - 22px)}
      .hint{top:64px}
    }
  </style>
</head>
<body>
<div id="game">
  <canvas id="c"></canvas>
  <div id="vfx"></div>
  <div id="grain"></div>

  <div class="hud">
    <div class="hint" id="hint">ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§ç§»å‹•ãƒ»æ‚£è€…ã‚¯ãƒªãƒƒã‚¯ã§å‡¦ç½®</div>

    <div class="panel" id="scorePanel">
      <div class="head">
        <div class="badge"><i class="iconDot"></i> Score</div>
        <div style="font-weight:1000;font-size:18px" id="score">0</div>
      </div>
      <div class="body">
        <div class="row">
          <div class="k">JP_001</div>
          <div class="v">Rainy Street</div>
        </div>
        <div class="submenu">
          <div class="pill">One-Screen</div>
          <div class="pill">Tactics</div>
          <div class="pill">EMS</div>
        </div>
        <small>â€» é»’èƒŒæ™¯PNGã¯è‡ªå‹•ã§é€éï¼ˆã‚¯ãƒ­ãƒã‚­ãƒ¼ï¼‰ã—ã¾ã™</small>
      </div>
    </div>

    <div class="panel" id="missionPanel">
      <div class="head">
        <div class="badge"><i class="iconDot"></i> Mission</div>
        <div class="tag">JP_001</div>
      </div>
      <div class="body" id="missions"></div>
    </div>

    <div id="party"></div>

    <div id="actionBar">
      <button class="actionBtn primary" id="btnDispatch">å‡ºå‹•<span class="mini">Shift / Enter</span></button>
      <button class="actionBtn" id="btnInventory">è£…å‚™<span class="mini">I</span></button>
      <button class="actionBtn" id="btnTriage">ãƒˆãƒªã‚¢ãƒ¼ã‚¸<span class="mini">T</span></button>
      <button class="actionBtn" id="btnPause">ä¸€æ™‚åœæ­¢<span class="mini">Esc</span></button>
    </div>

    <div class="panel" id="treatPanel">
      <div class="head">
        <div class="badge"><i class="iconDot"></i> æ‚£è€…</div>
        <div class="tag" id="patientTag">æœªé¸æŠ</div>
      </div>
      <div class="body">
        <div id="treatLeft">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div style="font-weight:1000;font-size:16px" id="patientName">â€”</div>
            <div style="display:flex;gap:8px;align-items:center">
              <small>çŠ¶æ…‹</small>
              <div class="meter" style="width:130px"><i id="hpbar"></i></div>
            </div>
          </div>
          <div class="note" id="patientNote" style="margin-top:10px">
            æ‚£è€…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å‡¦ç½®ãŒé¸ã¹ã¾ã™ã€‚<br/>
            LEG / FACE ã‚’æŠ¼ã™ã¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒé€²è¡Œã—ã€ã‚¹ã‚³ã‚¢ãŒå¢—ãˆã¾ã™ã€‚
          </div>
        </div>

        <div id="treatRight">
          <button class="tbtn good" id="btnLeg">ğŸ¦µ LEG</button>
          <button class="tbtn good" id="btnFace">ğŸ« FACE</button>
          <button class="tbtn bad" id="btnCancel">âœ– CANCEL</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * ç½®ããƒ•ã‚¡ã‚¤ãƒ«ï¼š
 *  - bg_rainy.png  (èƒŒæ™¯)
 *  - JIN.png / RYO.png / BOLT.png / KATE.png / MIA.png / NOAH.png / AYO.png
 */

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const DPR = Math.min(2, window.devicePixelRatio || 1);

function resize(){
  const w = canvas.clientWidth = canvas.parentElement.clientWidth;
  const h = canvas.clientHeight = canvas.parentElement.clientHeight;
  canvas.width = Math.floor(w * DPR);
  canvas.height = Math.floor(h * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize", resize);

const assets = {
  bg: "bg_rainy.png",
  chars: {
    JIN:"JIN.png",
    RYO:"RYO.png",
    BOLT:"BOLT.png",
    KATE:"KATE.png",
    MIA:"MIA.png",
    NOAH:"NOAH.png",
    AYO:"AYO.png"
  }
};

function loadImage(src){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(img);
    img.onerror = ()=> reject(new Error("Failed to load: " + src));
    img.src = src;
  });
}

/** â˜…é»’èƒŒæ™¯ã‚’è‡ªå‹•ã§é€æ˜åŒ–ï¼ˆã‚¯ãƒ­ãƒã‚­ãƒ¼ï¼‰ */
function chromaKeyToTransparent(img, threshold = 28) {
  const c = document.createElement("canvas");
  c.width = img.width;
  c.height = img.height;
  const x = c.getContext("2d");
  x.drawImage(img, 0, 0);

  const im = x.getImageData(0, 0, c.width, c.height);
  const d = im.data;

  for (let i = 0; i < d.length; i += 4) {
    const r = d[i], g = d[i + 1], b = d[i + 2], a = d[i + 3];
    if (a === 0) continue;

    // ã»ã¼é»’ã‚’é€æ˜åŒ–ï¼ˆå¿…è¦ãªã‚‰ threshold ã‚’ 18ã€œ45ã§èª¿æ•´ï¼‰
    if (r <= threshold && g <= threshold && b <= threshold) {
      d[i + 3] = 0;
    }
  }

  x.putImageData(im, 0, 0);
  const out = new Image();
  out.src = c.toDataURL("image/png");
  return out;
}

let IMG_BG;
const IMG_CHAR = {};
let ready = false;

const state = {
  score: 0,
  paused: false,
  active: "JIN",
  missions: [
    { id:1, text:"ç¾å ´å®‰å…¨ç¢ºèªï¼ˆãƒ›ãƒƒã‚¿ï¼‰", done:false, tag:"" },
    { id:2, text:"æ‚£è€…Aã«æ¥è¿‘ â†’ å‡ºè¡€ï¼ˆLEGï¼‰", done:false, tag:"LEG" },
    { id:3, text:"æ‚£è€…Aã«å¯¾å‡¦ â†’ å‘¼å¸ï¼ˆFACEï¼‰", done:false, tag:"FACE" },
  ],
  patient: {
    id:"A",
    name:"æ‚£è€…Aï¼ˆäº¤é€šå¤–å‚·ï¼‰",
    x: 1120, y: 770,
    hp: 0.55,
    selected:false,
    treatedLeg:false,
    treatedFace:false
  }
};

const party = [
  {key:"JIN",  label:"JIN",  x: 980,  y: 860, speed: 240},
  {key:"RYO",  label:"RYO",  x: 1310, y: 700, speed: 240},
  {key:"BOLT", label:"BOLT", x: 1080, y: 1010, speed: 240},
  {key:"KATE", label:"KATE", x: 1180, y: 820, speed: 240},
  {key:"MIA",  label:"MIA",  x: 840,  y: 760, speed: 240},
  {key:"NOAH", label:"NOAH", x: 1430, y: 740, speed: 240},
  {key:"AYO",  label:"AYO",  x: 960,  y: 990, speed: 240},
];

function getChar(key){ return party.find(p=>p.key===key); }

// click-to-move
const moveTarget = {x:null, y:null};

// â€œOCTOPATHã£ã½ã„â€é›°å›²æ°—ï¼šç¸®å°ï¼‹ã‚·ãƒ£ãƒ¼ãƒ—ï¼ˆæœ€è¿‘å‚ï¼‰
function drawSprite(img, x, y, scale=0.18, anchor=0.88){
  if(!img) return;
  const w = img.width * scale;
  const h = img.height * scale;
  ctx.imageSmoothingEnabled = false;
  ctx.drawImage(img, x - w/2, y - h*anchor, w, h);
  ctx.imageSmoothingEnabled = true;
}

function drawShadow(x,y,r=18){
  ctx.beginPath();
  ctx.ellipse(x,y, r*1.2, r*0.55, 0, 0, Math.PI*2);
  ctx.fillStyle = "rgba(0,0,0,.35)";
  ctx.fill();
}

// Rain particles
const rain = Array.from({length:260}, ()=>({
  x: Math.random()*1,
  y: Math.random()*1,
  z: 0.35 + Math.random()*0.9,
  s: 0.8 + Math.random()*1.6
}));

function drawRain(dt, W, H){
  ctx.save();
  ctx.globalCompositeOperation = "screen";
  ctx.strokeStyle = "rgba(170,200,255,.22)";
  ctx.lineWidth = 1;

  for(const p of rain){
    p.y += (0.55 * p.z) * dt;
    p.x += (0.08 * p.z) * dt;
    if(p.y > 1.05){ p.y = -0.05; p.x = Math.random()*1; }

    const x = p.x*W;
    const y = p.y*H;
    const len = 18*p.z;
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x - 6*p.z, y + len);
    ctx.stroke();
  }
  ctx.restore();
}

// Puddle ripples
let rippleT = 0;
function drawRipples(dt,W,H){
  rippleT += dt;
  const n=5;
  ctx.save();
  ctx.globalCompositeOperation = "screen";
  for(let i=0;i<n;i++){
    const t = (rippleT*0.6 + i*0.35) % 1;
    const x = (0.18 + i*0.16) * W;
    const y = (0.78 - i*0.07) * H;
    const r = 10 + 45*t;
    ctx.beginPath();
    ctx.ellipse(x,y, r*1.6, r*0.6, 0, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(150,190,255,${0.12*(1-t)})`;
    ctx.lineWidth = 2*(1-t);
    ctx.stroke();
  }
  ctx.restore();
}

// UI binding
const elScore = document.getElementById("score");
const elMissions = document.getElementById("missions");
const elPatientTag = document.getElementById("patientTag");
const elPatientName = document.getElementById("patientName");
const elPatientNote = document.getElementById("patientNote");
const elHpbar = document.getElementById("hpbar");
const elHint = document.getElementById("hint");

function renderMissions(){
  elMissions.innerHTML = state.missions.map(m=>{
    const cls = m.done ? "missionLine done" : "missionLine";
    const right = m.tag ? `<span class="tag">${m.tag}</span>` : `<span style="opacity:.65"> </span>`;
    return `
      <div class="${cls}">
        <div style="display:flex;align-items:center;gap:8px;min-width:0">
          <span class="chk">${m.done ? "âœ“" : ""}</span>
          <span class="txt" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${m.id}. ${m.text}</span>
        </div>
        ${right}
      </div>
    `;
  }).join("");
}
function setScore(v){
  state.score = v;
  elScore.textContent = String(v);
}
function openPatient(){
  const p = state.patient;
  p.selected = true;
  elPatientTag.textContent = "è»Šä¸¡A / æ‚£è€…A";
  elPatientName.textContent = p.name;
  elHpbar.style.width = Math.round(p.hp*100) + "%";
  elPatientNote.innerHTML = `
    <b style="color:#ffd9a1">è¦³å¯Ÿ:</b> é›¨å¤©ãƒ»æ»‘ã‚Šã‚„ã™ã„è·¯é¢ã€‚äºŒæ¬¡ç½å®³æ³¨æ„ã€‚<br>
    <b style="color:#ffd9a1">æ‰€è¦‹:</b> å‡ºè¡€ã‚ã‚Š / å‘¼å¸è©•ä¾¡ãŒå¿…è¦ã€‚<br>
    <small>â€» LEG â†’ å‡ºè¡€å¯¾å¿œ / FACE â†’ å‘¼å¸ãƒ»æ°—é“è©•ä¾¡ï¼ˆãƒ‡ãƒ¢ï¼‰</small>
  `;
}
function closePatient(){
  state.patient.selected = false;
  elPatientTag.textContent = "æœªé¸æŠ";
  elPatientName.textContent = "â€”";
  elPatientNote.innerHTML = `æ‚£è€…ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å‡¦ç½®ãŒé¸ã¹ã¾ã™ã€‚<br/>LEG / FACE ã‚’æŠ¼ã™ã¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒé€²è¡Œã—ã€ã‚¹ã‚³ã‚¢ãŒå¢—ãˆã¾ã™ã€‚`;
}
function completeMission(id){
  const m = state.missions.find(x=>x.id===id);
  if(m && !m.done){
    m.done = true;
    setScore(state.score + 10);
    renderMissions();
  }
}
renderMissions();

// Party UI
const partyEl = document.getElementById("party");
partyEl.innerHTML = party.map((c,i)=>`
  <div class="slot ${c.key===state.active?'active':''}" data-key="${c.key}" title="${c.label} ( ${i+1} )">
    <span>${i+1}</span>
  </div>
`).join("");

function setActive(key){
  state.active = key;
  [...partyEl.querySelectorAll(".slot")].forEach(s=>{
    s.classList.toggle("active", s.dataset.key===key);
  });
  elHint.textContent = `æ“ä½œã‚­ãƒ£ãƒ©: ${key} / ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•ãƒ»æ‚£è€…ã‚¯ãƒªãƒƒã‚¯ã§å‡¦ç½®`;
}
partyEl.addEventListener("click",(e)=>{
  const slot = e.target.closest(".slot");
  if(!slot) return;
  setActive(slot.dataset.key);
});
window.addEventListener("keydown",(e)=>{
  if(e.key>="1" && e.key<="7"){
    const idx = Number(e.key)-1;
    if(party[idx]) setActive(party[idx].key);
  }
  if(e.key==="Escape") togglePause();
  if(e.key==="Enter" || e.key==="Shift") dispatchPulse();
});

// Action Buttons
document.getElementById("btnPause").addEventListener("click", togglePause);
document.getElementById("btnDispatch").addEventListener("click", dispatchPulse);
document.getElementById("btnInventory").addEventListener("click", ()=>toast("è£…å‚™ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"));
document.getElementById("btnTriage").addEventListener("click", ()=>toast("ãƒˆãƒªã‚¢ãƒ¼ã‚¸ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰"));

function togglePause(){
  state.paused = !state.paused;
  toast(state.paused ? "PAUSE" : "RESUME");
}
function dispatchPulse(){
  completeMission(1);
  toast("å‡ºå‹•ï¼šç¾å ´å®‰å…¨ç¢ºèªã‚’æ›´æ–°");
}
function toast(text){
  elHint.textContent = text;
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>{ setActive(state.active); }, 1400);
}

// Treatment Buttons
document.getElementById("btnLeg").addEventListener("click", ()=>{
  if(!state.patient.selected) return;
  if(!state.patient.treatedLeg){
    state.patient.treatedLeg = true;
    completeMission(2);
    state.patient.hp = Math.min(1, state.patient.hp + 0.15);
    openPatient();
    toast("LEGï¼šå‡ºè¡€å¯¾å¿œï¼ˆãƒ‡ãƒ¢ï¼‰ +10");
  } else toast("LEGï¼šå‡¦ç½®æ¸ˆã¿");
});
document.getElementById("btnFace").addEventListener("click", ()=>{
  if(!state.patient.selected) return;
  if(!state.patient.treatedFace){
    state.patient.treatedFace = true;
    completeMission(3);
    state.patient.hp = Math.min(1, state.patient.hp + 0.12);
    openPatient();
    toast("FACEï¼šå‘¼å¸è©•ä¾¡ï¼ˆãƒ‡ãƒ¢ï¼‰ +10");
  } else toast("FACEï¼šå‡¦ç½®æ¸ˆã¿");
});
document.getElementById("btnCancel").addEventListener("click", ()=>{
  closePatient();
  toast("ã‚­ãƒ£ãƒ³ã‚»ãƒ«");
});

// Coordinate mapping (background is 2048x1365)
const WORLD = { w: 2048, h: 1365 };

function screenToWorld(mx,my){
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  const s = Math.max(W / WORLD.w, H / WORLD.h);
  const drawW = WORLD.w * s;
  const drawH = WORLD.h * s;
  const ox = (W - drawW) / 2;
  const oy = (H - drawH) / 2;
  return { x: (mx - ox) / s, y: (my - oy) / s };
}
function worldToScreen(wx,wy){
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  const s = Math.max(W / WORLD.w, H / WORLD.h);
  const drawW = WORLD.w * s;
  const drawH = WORLD.h * s;
  const ox = (W - drawW) / 2;
  const oy = (H - drawH) / 2;
  return { x: ox + wx*s, y: oy + wy*s, s };
}

// Input: click/tap
canvas.addEventListener("pointerdown",(e)=>{
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const w = screenToWorld(mx,my);

  // patient hit test
  const p = state.patient;
  const hit = Math.hypot(w.x - p.x, w.y - p.y) < 60;

  if(hit){
    openPatient();
    toast("æ‚£è€…Aã‚’é¸æŠ");
    return;
  }

  closePatient();
  moveTarget.x = w.x;
  moveTarget.y = w.y;
});

// Movement update
function updateMovement(dt){
  const ch = getChar(state.active);
  if(moveTarget.x==null) return;

  const dx = moveTarget.x - ch.x;
  const dy = moveTarget.y - ch.y;
  const d = Math.hypot(dx,dy);
  if(d < 4){
    moveTarget.x = moveTarget.y = null;
    return;
  }
  const vx = (dx/d) * ch.speed;
  const vy = (dy/d) * ch.speed;
  ch.x += vx * dt;
  ch.y += vy * dt;

  // Near patient hint
  const p = state.patient;
  if(Math.hypot(ch.x - p.x, ch.y - p.y) < 120){
    elHint.textContent = "æ‚£è€…ãŒè¿‘ã„ï¼šã‚¯ãƒªãƒƒã‚¯ã§å‡¦ç½®";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>{ setActive(state.active); }, 900);
  }
}

// Render
function drawBG(){
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  const s = Math.max(W / WORLD.w, H / WORLD.h);
  const drawW = WORLD.w * s;
  const drawH = WORLD.h * s;
  const ox = (W - drawW) / 2;
  const oy = (H - drawH) / 2;

  ctx.save();
  ctx.drawImage(IMG_BG, ox, oy, drawW, drawH);

  // subtle glow
  ctx.globalCompositeOperation = "screen";
  ctx.fillStyle = "rgba(255,190,120,.05)";
  ctx.fillRect(0,0,W,H);

  // light shafts
  ctx.fillStyle = "rgba(255,220,150,.06)";
  ctx.beginPath();
  ctx.ellipse(W*0.27, H*0.30, W*0.18, H*0.25, 0.55, 0, Math.PI*2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(W*0.78, H*0.32, W*0.16, H*0.22, -0.25, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

function drawPatient(){
  const p = state.patient;
  const sp = worldToScreen(p.x, p.y);
  const x = sp.x, y = sp.y;

  ctx.save();
  ctx.globalAlpha = 0.95;

  drawShadow(x,y, 22);

  ctx.translate(x,y-18);
  ctx.rotate(-0.3);
  ctx.fillStyle = "rgba(180,200,220,.9)";
  ctx.strokeStyle = "rgba(0,0,0,.35)";
  ctx.lineWidth = 2;
  roundRect(-28,-10,56,20,10, true, true);
  ctx.fillStyle = "rgba(80,120,160,.9)";
  roundRect(-18,-26,36,16,10, true, true);
  ctx.restore();

  if(p.selected){
    ctx.save();
    ctx.globalCompositeOperation = "screen";
    ctx.strokeStyle = "rgba(255,184,77,.45)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.ellipse(x,y, 44, 18, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }
}

function roundRect(x,y,w,h,r,fill,stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function drawCharacters(){
  const sorted = [...party].sort((a,b)=>a.y-b.y);
  for(const c of sorted){
    const sp = worldToScreen(c.x, c.y);
    const x = sp.x, y = sp.y;
    drawShadow(x,y, 20);

    const img = IMG_CHAR[c.key];
    const scale = (c.key===state.active) ? 0.195 : 0.18;
    drawSprite(img, x, y, scale, 0.88);

    ctx.save();
    ctx.font = "700 12px system-ui";
    ctx.textAlign = "center";
    ctx.fillStyle = "rgba(245,235,214,.85)";
    ctx.strokeStyle = "rgba(0,0,0,.55)";
    ctx.lineWidth = 3;
    const labelY = y + 26;
    ctx.strokeText(c.label, x, labelY);
    ctx.fillText(c.label, x, labelY);
    ctx.restore();
  }
}

function drawMoveMarker(){
  if(moveTarget.x==null) return;
  const sp = worldToScreen(moveTarget.x, moveTarget.y);
  const x = sp.x, y = sp.y;
  ctx.save();
  ctx.globalCompositeOperation = "screen";
  ctx.strokeStyle = "rgba(74,163,255,.5)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.ellipse(x,y, 22, 9, 0, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();
}

let last = performance.now();
function loop(now){
  const dt = Math.min(0.033, (now-last)/1000);
  last = now;

  resize();

  if(ready){
    if(!state.paused) updateMovement(dt);

    ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);
    drawBG();

    drawRipples(dt, canvas.clientWidth, canvas.clientHeight);
    drawPatient();
    drawCharacters();
    drawMoveMarker();

    drawRain(dt, canvas.clientWidth, canvas.clientHeight);
  }

  requestAnimationFrame(loop);
}

async function boot(){
  try{
    IMG_BG = await loadImage(assets.bg);

    // â˜…ã“ã“ã§é»’èƒŒæ™¯PNGã‚‚é€éåŒ–ã—ã¦èª­ã¿è¾¼ã¿
    for (const k of Object.keys(assets.chars)) {
      const raw = await loadImage(assets.chars[k]);
      IMG_CHAR[k] = chromaKeyToTransparent(raw, 28);
    }

    ready = true;

    setActive(state.active);
    setScore(0);
    closePatient();

  }catch(err){
    console.error(err);
    document.getElementById("hint").textContent = "ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ï¼š" + err.message;
  }
  requestAnimationFrame(loop);
}
boot();
</script>
</body>
</html>
